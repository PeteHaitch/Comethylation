{"name":"Co-methylation","tagline":"A methylation caller for methylation events that co-occur on the same DNA fragment from high-throughput bisulfite-sequencing data, such as methylC-seq.","body":"[![Build Status](https://travis-ci.org/PeteHaitch/comethylation.png?branch=master)](https://travis-ci.org/PeteHaitch/comethylation)\r\n\r\n# comethylation\r\n\r\n`comethylation` is a methylation caller for methylation events that co-occur on the same DNA fragment from high-throughput bisulfite sequencing data, such as `methylC-seq`. A typical read from such an experiment reports a binary methylated or unmethylated measurement at multiple loci, where each read originates from a single cell. `comethylation` allows us to investigate the co-occurence of methylation marks at the level of a single cell.\r\n\r\n# Installation and dependencies\r\nSimply running \r\n\r\n```\r\npython setup.py install\r\n```\r\nin the root `comethylation` directory should work for most systems.\r\n\r\n`comethylation` is written in Python and relies upon the pysam module. Running `python setup.py install` will attempt to install pysam if it isn't found on your system. Alternatively, pysam is available from [https://code.google.com/p/pysam/](https://code.google.com/p/pysam/).\r\n\r\n`comethylation` has only been tested on Python 2.7 with pysam v0.7.7.\r\n\r\n# Usage\r\n## Method\r\n`comethylation` extracts _m-tuples_ of methylation loci that co-occur on the same read. The simplest _m-tuple_ is the 1-tuple (m = 1), which corresponds to counting the number of reads that are methylated (_M_) and unmethylated (_U_) for each cytosine in the genome; 1-tuples are the type of methylation calling performed by most methylation calling software such as Bismark's `bismark_methylation_extractor`. \r\n\r\nA 2-tuple (m = 2) is a pair of methylation loci; `comethylation` tabulates the number of reads that methylated at each locus in the pair (_MM_), both unmethylated (_UU_) or methylated at one locus but not the other (_MU_ or _UM_). This idea extends to 3-tuples, 4-tuples, etc. \r\n\r\nFor a chosen value of _m_, all _m-tuples_ are extracted and tabulated across the genome. The key point is that _m-tuples_ are only constructed if all _m_ loci are within a single read, so we can investigate the co-occurence of methylation events at the level of a single cell.\r\n\r\n## Basic usage\r\n`comethylation` processes a single `BAM` file and works for both single-end and paired-end sequencing data. Example `BAM` files from single-end directional and paired-end directional bisulfite-sequencing experiments are available in the `data/` directory. \r\n\r\nMethylation measurements may be filtered by base quality or other criteria such as the mapping quality of the read or whether the read is marked as a PCR duplicate. For a full list of filtering options, please run `comethylation --help` or see the __Advanced Usage__ section below. \r\n\r\nCurrently, the BAM file must have been created with [Bismark](http://www.bioinformatics.bbsrc.ac.uk/projects/download.html#bismark). If the data were aligned with Bismark version < 0.8.3 please use the `--oldBismark` flag. A future version of this software will support the use of BAM files created with other popular bisulfite aligners such as [BSMAP](https://code.google.com/p/bsmap/), [BSmooth](https://github.com/BenLangmead/bsmooth-align), [bwa-meth](https://github.com/brentp/bwa-meth/), [gsnap](http://research-pub.gene.com/gmap/), [last](http://last.cbrc.jp/) and [Novoalign](http://www.novocraft.com/). Support will either be provided natively in `comethylation` or via an pre-processing script `bismarkify`.\r\n\r\nThe main options to pass `comethylation` are the size of the m-tuple (`--mTuple`); the type of methylation, which is some combination of _CG_, _CHG_, _CHH_ and _CNN_ (`--methylationType`); any filters to be applied to reads or positions within reads (see below); the BAM file; and the sample name, which will be used as a prefix for all output files. \r\n\r\nTo simultaneously study multiple methylation types the `--methylationType` parameter must be specified multiple times, e.g. to study CG and CHH methylation `--methylationType CG --methylationType CHH`.\r\n\r\n## Output\r\nThree output files are created and summary information is written to `STDOUT`.\r\n\r\nThe main output file is a tab-delimited file of all m-tuples (`<sampleName>.<--methylationType>.<--mTuple>.tsv`). \r\n\r\nHere are the 5 rows (along with the header row) from `data/se_directional.fq.gz_bismark_bt2.CG.2.tsv`, which is created by running the single-end directional example shown below:\r\n\r\n```\r\nchr\t\tpos1\t\tpos2\t\tMM\tMU\tUM\tUU\r\nchr10\t42383637\t42383660\t1\t0\t0\t0\r\nchr10\t42383660\t42383672\t0\t2\t0\t0\r\nchr10\t42383672\t42383686\t0\t0\t2\t0\r\nchr10\t42385004\t42385040\t1\t0\t0\t0\r\nchr10\t42385040\t42385063\t1\t0\t0\t0\r\n```\r\nSo, for the CpG 2-tuple chr10:(42,383,637, 42,383,660) we observed 1 read that was methylated at chr10:42,383,637 and methylated at chr10:42,383,660. For CpG 2-tuple chr10:(42,383,660, 42,383,672) we observed 2 reads that were both methylated at chr10:42,383,660 but unmethylated at chr10:42,383,672.\r\n\r\nThe second file (`<sampleName>.<--methylationType>_per_read.hist`) is a text histogram of the number of methylation loci per read or readpair (of the type specified by `--methylationType`) that passed the filters specified at runtime of `comethylation`.\r\n\r\nHere is the file `data/se_directional.fq.gz_bismark_bt2.CG_per_read.hist`, which is created by running the single-end directional example shown below:\r\n\r\n```\r\nn       count\r\n0       4389\r\n1       2262\r\n2       750\r\n3       287\r\n4       131\r\n5       55\r\n6       27\r\n7       18\r\n8       3\r\n9       4\r\n10      2\r\n11      1\r\n12      3\r\n13      4\r\n14      1\r\n18      2\r\n```\r\nSo, 4,389 reads aligned to a position with no CpGs while 2 reads aligned to a position with 18 CpGs.\r\n\r\nAn optional third and final file (`<sampleName.reads_that_failed_QC.txt>`) records the querynames (`QNAME`) of all reads that failed to pass quality control filters and which filter the read failed. This file may be omitted by use of the `--noFailedQCFile` flag.\r\n\r\nHere are the first 2 rows of `data/se_directional.fq.gz_bismark_bt2.reads_that_failed_QC.txt`, which is created by running the single-end directional example shown below:\r\n\r\n```\r\nSRR921747.5_JONAS:2105:C0G2AACXX:4:2205:18672:56112_length=101  read has indel\r\nSRR921747.81_JONAS:2105:C0G2AACXX:4:2205:18836:56196_length=101 read has indel\r\n```\r\nSo, both of these reads were filtered out because they contained indels (see section \"__Limitations and notes__\").\r\n\r\n## Examples\r\nTwo small example datasets are included in the `data/` directory. Included are the `FASTQ` files and the `BAM` files generated with __Bismark__ in __Bowtie2__ mode. More details of the example datasets can be found in `data/README.md`\r\n\r\nAlthough the example datasets are both from directional bisulfite-sequencing protocols, `comethylation` works with data from both directional and non-directional bisulfite-sequencing protocols.\r\n\r\n\r\n### Single-end\r\nThe following command will extract all CpG 2-tuples from the file `data/se_directional.bam`:\r\n\r\n```\r\ncomethylation --mTuple 2 --methylationType CG data/se_directional.fq.gz_bismark_bt2.bam data/se_directional.fq.gz_bismark_bt2\r\n```\r\n\r\nThis results in 3 files: \r\n\r\n* `data/se_directional.fq.gz_bismark_bt2.CG.2.tsv`\r\n* `data/se_directional.fq.gz_bismark_bt2.CG_per_read.hist`\r\n* `data/se_directional.fq.gz_bismark_bt2.reads_that_failed_QC.txt`\r\n\r\n\r\n\r\n### Paired-end\r\nPaired-end data must firstly be sorted by queryname prior to running `comethylation`. `BAM` files created by Bismark, such as `data/pe_directional.bam`, are already sorted by queryname. So, to extract all CG/CHH 3-tuples we would simply run:\r\n\r\n```\r\ncomethylation --mTuple 3 --methylationType CG --methylationType CHH --strandSpecific data/pe_directional_1.fq.gz_bismark_bt2_pe.bam data/pe_directional_1.fq.gz_bismark_bt2_pe\r\n```\r\nNote that we had to specify `--strandSpecific` because __CHH__ methylation is not symmetric between the Watson and Crick strands.\r\n\r\nThis results in 3 files: \r\n\r\n* `data/pe_directional_1.fq.gz_bismark_bt2_pe.CG_CHH.3.tsv`\r\n* `data/pe_directional_1.fq.gz_bismark_bt2_pe.CG_CHH_per_read.hist` \r\n* `data/pe_directional_1.fq.gz_bismark_bt2_pe.reads_that_failed_QC.txt`\r\n\r\nIf your paired-end BAM file is sorted by genomic coordinates, then you must first sort the `BAM` by queryname and then run `comethylation` on the queryname-sorted `BAM`:\r\n\r\n```\r\n# Create a coordinate-sorted BAM for the sake of argument\r\nsamtools sort data/pe_directional_1.fq.gz_bismark_bt2_pe.bam data/cs_pe_directional_1.fq.gz_bismark_bt2_pe\r\n# Re-sort the coordinate-sorted BAM by queryname\r\nsamtools sort -n data/cs_pe_directional_1.fq.gz_bismark_bt2_pe.bam data/qs_pe_directional_1.fq.gz_bismark_bt2_pe\r\n# Run comethylation on the queryname sorted BAM\r\ncomethylation --mTuple 3 --strandSpecific --methylationType CG --methylationType CHH data/qs_pe_directional_1.fq.gz_bismark_bt2_pe.bam data/qs_pe_directional\r\n```\r\n\r\n## Memory usage and running time\r\nMemory usage is dependent upon the number of methylation loci on the chromosome (more methylation loci means increased memory usage) and the value of `--mTuple` (roughly, larger values means increased memory usage), but largely independent of the number of reads in the `BAM` file. In contrast, running time is dependent on the number of reads in the `BAM` file and largely independent of the choice of `--mTuple`.\r\n\r\nI will include more detailed performance benchmarks in future releases. For a rough indication of performance, here are the results for processing approximately 41,000,000 100bp paired-end reads from chr1 of a 20-30x coverage whole-genome methylC-seq experiment of human data. This analysis used a single AMD Opteron 6276 CPU (2.3GHz) on a shared memory system.\r\n\r\n### `--mTuple 2`\r\nMemory usage peaked at 2.9GB and the running time was approximately 1.5 hours. \r\n\r\n### `--mTuple 5`\r\nMemory usage peaked at 8.8GB and the running time was approximately 1.5 hours.\r\n\r\n## Helper script\r\nI frequently work with large, coordinate-sorted `BAM` files. To speed up the extraction of m-tuples I use a simple (naive) parallelisation strategy. The idea is to split the `BAM` file into chromosome-level `BAM` files, process each chromosome-level `BAM` separately and then recombine these chromosome-level files into a genome-level file. The script `helper_scripts/run_comethylation.sh` implements this strategy; simply edit the key variables in this script.\r\n\r\n### Warnings\r\n\r\n* __WARNING__: This simple strategy uses as many cores as there are chromosomes. This can result in __very__ large memory usage, depending on the value of `--mTuple`, and may cause problems if you have more chromosomes than available cores.\r\n* __WARNING__: The script `tabulate_hist.R` must be in the same directory as `run_comethylation.sh`\r\n\r\n## Advanced usage\r\n\r\nA full list of options is available by running `comethylation --help`:\r\n\r\n```\r\nusage: comethylation [-h] [--mTuple <int>] [--methylationType <string>]\r\n                     [--oldBismark] [--ignoreDuplicates]\r\n                     [--ignoreStart_r1 <int>] [--ignoreStart_r2 <int>]\r\n                     [--ignoreEnd_r1 <int>] [--ignoreEnd_r2 <int>]\r\n                     [--minQual <int>] [--minMapQ <int>] [--phred64]\r\n                     [--overlappingPairedEndFilter <string>]\r\n                     [--strandSpecific] [--useImproperPairs]\r\n                     [--noFailedQCFile] [--version]\r\n                     BAM sampleName\r\n\r\nExtract within-fragment co-methylation measurements at methylation loci from\r\nthe aligned reads of a bisulfite-sequencing experiment. WARNING: Requires\r\nBismark-style BAM files including XG-, XR- and XM-tags and corrected SAM\r\nflags. Currently only supports the directional (aka 2-strand) bisulfite-\r\nsequencing protocol.\r\n\r\npositional arguments:\r\n  BAM                   The path to the SAM/BAM file\r\n  sampleName            The name of the sample. All output files will have\r\n                        this prefix.\r\n\r\noptional arguments:\r\n  -h, --help            show this help message and exit\r\n  --mTuple <int>        The size of the methylation-loci m-tuples (i.e. the\r\n                        choice of m); must be an integer > 1 (default: 2).\r\n  --methylationType <string>\r\n                        The type of methylation loci to study: CG, CHG, CHH or\r\n                        CNN. This option may be specified multiple times in\r\n                        order to study multiple methylation types\r\n                        simultaneously, e.g. --methylationType CG\r\n                        --methylationType CHG\r\n  --oldBismark          SAM/BAM created with Bismark version < 0.8.3. The FLAG\r\n                        and QNAME field in SAM/BAM files created by these\r\n                        older versions of Bismark differed from the SAM\r\n                        specifications and need to be adjusted on the fly by\r\n                        comethylation\r\n  --ignoreDuplicates    Ignore reads that have been flagged as PCR duplicates\r\n                        by Picard's MarkDuplicates function\r\n  --ignoreStart_r1 <int>\r\n                        Ignore first <int> bases from start (5' end) of read\r\n                        (respectively, read_1) for single-end data\r\n                        (respectively, paired-end data) (default: 0). WARNING:\r\n                        Parameter value not sanity checked by program.\r\n  --ignoreStart_r2 <int>\r\n                        Only used if data are paired-end. Ignore first <int>\r\n                        bases from start (5' end) of read_2 (default: 0).\r\n                        WARNING: Parameter value not sanity checked by\r\n                        program.\r\n  --ignoreEnd_r1 <int>  Ignore last <int> bases from end (3' end) of read\r\n                        (respectively, read_1) for single-end data\r\n                        (respectively, paired-end data) (default: 0). WARNING:\r\n                        Parameter value not sanity checked by program.\r\n  --ignoreEnd_r2 <int>  Only used if data are paired-end. Ignore last <int>\r\n                        bases from end (5' end) of read_2 (default: 0).\r\n                        WARNING: Parameter value not sanity checked by\r\n                        program.\r\n  --minQual <int>       Minimum base-quality (default: 0). Any base with a\r\n                        lower base-quality is ignored.\r\n  --minMapQ <int>       Minimum mapping quality mapQ (default: 0). Any read\r\n                        with a lower mapQ is ignored. WARNING: This option has\r\n                        no effect with SAM/BAM files created with Bismark.\r\n                        Bismark sets all mapQ values to 255, which indicates\r\n                        that the mapping quality is not available.\r\n  --phred64             Quality scores are encoded as Phred64 (default:\r\n                        Phred33).\r\n  --overlappingPairedEndFilter <string>\r\n                        What filter should be applied to any overlapping\r\n                        paired-end reads. Read-pairs that don't pass the\r\n                        filter are not used for methylation calling (options\r\n                        listed by most-to-least stringent): check the entire\r\n                        overlapping sequence is identical (sequence), check\r\n                        the XM-tag is identical for the overlapping region\r\n                        (XM), do no check of the overlapping bases but use the\r\n                        read with the higher quality basecalls in the\r\n                        overlapping region (quality), do no check of the\r\n                        overlapping bases and just use the overlapping bases\r\n                        from read_1 a la bismark_methylation_extractor\r\n                        (bismark) (default: XM).\r\n  --strandSpecific      Produce strand-specific counts, i.e. don't collapse\r\n                        methylation calls across Watson and Crick strands\r\n  --useImproperPairs    Do not filter out improper readpairs. The definition\r\n                        of a proper readpair is aligner-specific and the value\r\n                        set with the 0x2 bit in the SAM flag\r\n  --noFailedQCFile      Do not create the file listing the reads that failed\r\n                        to pass a QC filter and which filter they failed\r\n  --version             show program's version number and exit\r\n```\r\n\r\n\r\n# Limitations and notes\r\nThese are current limitations and their statuses:\r\n\r\n## Only works with data aligned with the __Bismark__ mapping software \r\n`comethylation` makes use of Bismark's custom SAM tags `XM`, `XR` and `XG`. The `XM` tag is used to infer the methylation state of each sequenced cytosine while the `XR` and `XG` tags are used to infer the orientation and strand of the alignment. If the data were aligned with Bismark version < 0.8.3 please use the `--oldBismark` flag.\r\n\r\nA future version of this software will support the use of `BAM` files created with other popular bisulfite aligners such as [BSMAP](https://code.google.com/p/bsmap/), [BSmooth](https://github.com/BenLangmead/bsmooth-align), [bwa-meth](https://github.com/brentp/bwa-meth/), [gsnap](http://research-pub.gene.com/gmap/), [last](http://last.cbrc.jp/) and [Novoalign](http://www.novocraft.com/). Support will either be provided natively in `comethylation` or via an pre-processing script `bismarkify`. See [Issue #30](https://github.com/PeteHaitch/comethylation/issues/30)\r\n\r\n## Paired-end data must be sorted by queryname\r\nThis is required in order to avoid lookups when finding the mate of a paired-end read.\r\n\r\nThe `BAM` file created by Bismark is natively in queryname order so this is not a problem. If the file is not in queryname order then use `samtools sort` with the `-n` option to sort you `BAM` by queryname. The helper script `helper_scripts/run_comethylation.sh` works with a coordinate-sorted `BAM` file and so includes a step to sort the chromosome-level `BAM` files by queryname.\r\n\r\n## `comethylation` will skip any read containing an indel \r\nIt is difficult, although not impossible, to assign coordinates to a cytosine within an indel. To avoid this complication, `comethylation` currently skips any reads containing an indel. I aim to improve the handling of indels in the next release.\r\n\r\n## The `--oldBismark` option is a bit crude\r\nSpecifically, it assumes that there are no '/' characters in the read names (`QNAME`) and that the BAM has not been processed with any other programs, e.g. Picard's MarkDuplicates, that might change the `FLAG` field. I am happy to improve this functionality if requested.\r\n\r\n## Memory usage can be large \r\nFor instance, 5-20Gb per chromosome for a typical 20-30x coverage whole-genome methylC-seq experiment of human data. I think this is largely due to inefficiencies in how I store the m-tuples internally in `comethylation` (which is basically as a dictionary of dictionaries). See [Issue #64](https://github.com/PeteHaitch/comethylation/issues/64)\r\n\r\n## Other notes\r\n\r\n* Bismark always sets the mapping quality (`mapQ`) as the value 255, which means unavailable in the SAM format specification. Thus the `--minMapQ` option will not have any effect for Bismark data.\r\n* `comethylation` skip paired-end reads where either mate is unmapped.\r\n\r\n# Acknowledgements\r\nA big thank you to [Felix Krueger](http://www.bioinformatics.babraham.ac.uk/people.html) (the author of Bismark) for his help in understanding mapping of bisulfite-sequencing data and for answering my many questions along the way.\r\n\r\nThanks also to Tobias Sargeant ([@folded](https://github.com/folded)) for his help in turning the original `comethylation.py` script into the current Python module `comethylation` and for help in setting up a testing framework.\r\n\r\n\r\n# Questions and comments\r\nPlease use the GitHub Issue Tracker (available at [www.github.com/PeteHaitch/comethylation](www.github.com/PeteHaitch/comethylation)) to file bug reports or request new functionality. I welcome questions and comments; you can email me at peter.hickey@gmail.com. \r\n","google":"UA-47957729-1","note":"Don't delete this file! It's used internally to help with page regeneration."}